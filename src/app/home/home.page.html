<ion-content class="custom-home">

  <app-message-box></app-message-box>

  <app-header [pageTitle]="'Inicio'" (toggleMenuEvent)="menu.toggleMenu()"></app-header>
  <app-sidebar-menu #menu [esAdmin]="isAdmin"></app-sidebar-menu>

  <div class="home-container" [class.menu-open]="menu.menuAbierto">

    <section class="slider">
      <div class="slide" *ngFor="let movie of featuredList; let i = index" [class.active]="i === sliderIndex"
        [style.backgroundImage]="'url(' + movie.imageUrl + ')'">
        <div class="content">
          <h2>{{ movie.title }}</h2>
          <p *ngIf="movie.description">{{ movie.description }}</p>

          <div class="ratings">
            <span *ngIf="movie.ParaTodosOAdultos" class="badge">{{ movie.ParaTodosOAdultos }}</span>
            <span *ngIf="movie.PegiRating" class="badge">{{ movie.PegiRating }}</span>
            <span *ngIf="movie.AgeRating" class="badge">{{ movie.AgeRating }}</span>
          </div>

          <div class="buttons">
            <button class="boton" (click)="abrirModalReproducir(featuredList[sliderIndex])">
              <i class="fa-solid fa-circle-play"></i> Reproducir
            </button>

            <button class="boton" (click)="goToCurrentSliderMovie()">
              <i class="fa-solid fa-circle-question"></i> Más información
            </button>
          </div>
        </div>
      </div>

      <div class="arrow left" (click)="prevSlide()">&#10094;</div>
      <div class="arrow right" (click)="nextSlide()">&#10095;</div>

      <div class="indicators">
        <span class="dot" *ngFor="let movie of featuredList; let i = index" [class.active]="i === sliderIndex"
          (click)="showSlide(i)"></span>
      </div>
    </section>

    <!-- Carrusel Destacadas -->
    <app-movie-carousel [title]="'Destacadas'" [movies]="featuredList" [isAdmin]="isAdmin" (select)="goToMovie($event)"
      (edit)="abrirModalEditar($event)" (delete)="deleteMovie($event)">
      <ng-template let-movie>
        <ng-container *ngIf="!movie.isLoading; else loadingMovie">
          <img [src]="movie.imageUrl" alt="{{ movie.title }}" />
          <h3>{{ movie.title }}</h3>
          <div class="ratings-small">
            <span *ngIf="movie.ParaTodosOAdultos" class="badge small">{{ movie.ParaTodosOAdultos }}</span>
            <span *ngIf="movie.PegiRating" class="badge small">{{ movie.PegiRating }}</span>
            <span *ngIf="movie.AgeRating" class="badge small">{{ movie.AgeRating }}</span>
          </div>
        </ng-container>
        <ng-template #loadingMovie>
          <app-movie-loading message="Cargando película..." />
        </ng-template>
      </ng-template>
    </app-movie-carousel>

    <!-- Carrusel Acción -->
    <app-movie-carousel [title]="'Acción'" [movies]="moviesAccion" [isAdmin]="isAdmin" (select)="goToMovie($event)"
      (edit)="abrirModalEditar($event)" (delete)="deleteMovie($event)">
      <ng-template let-movie>
        <ng-container *ngIf="!movie.isLoading; else loadingMovieAccion">
          <img [src]="movie.imageUrl" alt="{{ movie.title }}" />
          <h3>{{ movie.title }}</h3>
          <div class="ratings-small">
            <span *ngIf="movie.ParaTodosOAdultos" class="badge small">{{ movie.ParaTodosOAdultos }}</span>
            <span *ngIf="movie.PegiRating" class="badge small">{{ movie.PegiRating }}</span>
            <span *ngIf="movie.AgeRating" class="badge small">{{ movie.AgeRating }}</span>
          </div>
        </ng-container>
        <ng-template #loadingMovieAccion>
          <app-movie-loading message="Cargando película..." />
        </ng-template>
      </ng-template>
    </app-movie-carousel>

    <!-- Carrusel Romance -->
    <app-movie-carousel [title]="'Romance'" [movies]="moviesRomance" [isAdmin]="isAdmin" (select)="goToMovie($event)"
      (edit)="abrirModalEditar($event)" (delete)="deleteMovie($event)">
      <ng-template let-movie>
        <ng-container *ngIf="!movie.isLoading; else loadingMovieRomance">
          <img [src]="movie.imageUrl" alt="{{ movie.title }}" />
          <h3>{{ movie.title }}</h3>
          <div class="ratings-small">
            <span *ngIf="movie.ParaTodosOAdultos" class="badge small">{{ movie.ParaTodosOAdultos }}</span>
            <span *ngIf="movie.PegiRating" class="badge small">{{ movie.PegiRating }}</span>
            <span *ngIf="movie.AgeRating" class="badge small">{{ movie.AgeRating }}</span>
          </div>
        </ng-container>
        <ng-template #loadingMovieRomance>
          <app-movie-loading message="Cargando película..." />
        </ng-template>
      </ng-template>
    </app-movie-carousel>

    <!-- Carrusel Terror -->
    <app-movie-carousel [title]="'Terror'" [movies]="moviesTerror" [isAdmin]="isAdmin" (select)="goToMovie($event)"
      (edit)="abrirModalEditar($event)" (delete)="deleteMovie($event)">
      <ng-template let-movie>
        <ng-container *ngIf="!movie.isLoading; else loadingMovieTerror">
          <img [src]="movie.imageUrl" alt="{{ movie.title }}" />
          <h3>{{ movie.title }}</h3>
          <div class="ratings-small">
            <span *ngIf="movie.ParaTodosOAdultos" class="badge small">{{ movie.ParaTodosOAdultos }}</span>
            <span *ngIf="movie.PegiRating" class="badge small">{{ movie.PegiRating }}</span>
            <span *ngIf="movie.AgeRating" class="badge small">{{ movie.AgeRating }}</span>
          </div>
        </ng-container>
        <ng-template #loadingMovieTerror>
          <app-movie-loading message="Cargando película..." />
        </ng-template>
      </ng-template>
    </app-movie-carousel>

    <section *ngIf="isAdmin" class="admin-panel">
      <h2>Panel de Administración</h2>
      <p>Desde aquí puedes agregar nuevas películas a la cartelera.</p>
      <button class="admin-add" (click)="abrirModalAgregar()">Agregar Película</button>
    </section>

    <!-- MODAL AGREGAR / EDITAR -->
    <ion-modal [isOpen]="modalAbierto" (didDismiss)="cerrarModal()">
      <ng-template>
        <ion-header>
          <ion-toolbar color="dark">
            <ion-title>{{ editando ? 'Editar Película' : 'Agregar Película' }}</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="cerrarModal()">Cerrar</ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>

        <ion-content class="ion-padding">
          <ion-item>
            <ion-label position="floating">Título</ion-label>
            <ion-input [(ngModel)]="peliculaTemp.title" required></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="floating">URL de la imagen</ion-label>
            <ion-input [(ngModel)]="peliculaTemp.imageUrl" required></ion-input>
          </ion-item>

          <ion-item>
            <ion-label>Categoría</ion-label>
            <ion-select [(ngModel)]="peliculaTemp.category" interface="alert">
              <ion-select-option *ngFor="let cat of categorias" [value]="cat">{{ cat }}</ion-select-option>
            </ion-select>
          </ion-item>

          <ion-item>
            <ion-label position="floating">Descripción</ion-label>
            <ion-textarea [(ngModel)]="peliculaTemp.description"></ion-textarea>
          </ion-item>

          <ion-item>
            <ion-label position="floating">URL del tráiler</ion-label>
            <ion-input [(ngModel)]="peliculaTemp.trailerUrl"></ion-input>
          </ion-item>

          <ion-item>
            <ion-label position="floating">URL de la película</ion-label>
            <ion-input [(ngModel)]="peliculaTemp.movieUrl"></ion-input>
          </ion-item>

          <!-- NUEVO: Para Todos o Adultos -->
          <ion-item>
            <ion-label>Público</ion-label>
            <ion-select [(ngModel)]="peliculaTemp.ParaTodosOAdultos" interface="alert" placeholder="Seleccionar">
              <ion-select-option value="Para Todos">Para Todos</ion-select-option>
              <ion-select-option value="Adultos">Solo Adultos</ion-select-option>
            </ion-select>
          </ion-item>

          <!-- NUEVO: PEGI -->
          <ion-item>
            <ion-label>PEGI</ion-label>
            <ion-select [(ngModel)]="peliculaTemp.PegiRating" interface="alert" placeholder="Seleccionar PEGI">
              <ion-select-option value="PEGI 3">PEGI 3</ion-select-option>
              <ion-select-option value="PEGI 7">PEGI 7</ion-select-option>
              <ion-select-option value="PEGI 12">PEGI 12</ion-select-option>
              <ion-select-option value="PEGI 16">PEGI 16</ion-select-option>
              <ion-select-option value="PEGI 18">PEGI 18</ion-select-option>
            </ion-select>
          </ion-item>

          <!-- NUEVO: Age Rating -->
          <ion-item>
            <ion-label position="floating">Age Rating</ion-label>
            <ion-input [(ngModel)]="peliculaTemp.AgeRating" placeholder="Ej: +13, PG-13"></ion-input>
          </ion-item>

          <ion-button expand="block" color="warning" (click)="guardarPelicula()">
            {{ editando ? 'Guardar Cambios' : 'Agregar Película' }}
          </ion-button>
        </ion-content>
      </ng-template>
    </ion-modal>

    <!-- MODAL REPRODUCIR -->
    <ion-modal [isOpen]="modalReproducirAbierto" (didDismiss)="cerrarModalReproducir()">
      <ng-template>
        <ion-header>
          <ion-toolbar color="dark">
            <ion-title>{{ peliculaReproducir?.title }}</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="cerrarModalReproducir()">Cerrar</ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>

        <ion-content class="ion-padding">
          <div class="video-container">
            <ng-container
              *ngIf="esYoutubeUrl(peliculaReproducir?.trailerUrl || peliculaReproducir?.movieUrl); else videoLocal">
              <iframe width="100%" height="315"
                [src]="getSafeUrl(peliculaReproducir?.trailerUrl || peliculaReproducir?.movieUrl)" frameborder="0"
                allowfullscreen></iframe>
            </ng-container>

            <ng-template #videoLocal>
              <video *ngIf="peliculaReproducir?.movieUrl" [src]="peliculaReproducir?.movieUrl" controls autoplay
                width="100%"></video>
            </ng-template>
          </div>
        </ion-content>
      </ng-template>
    </ion-modal>

  </div>
</ion-content>
